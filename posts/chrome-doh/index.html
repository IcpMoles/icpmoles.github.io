<!doctype html><html lang=en-en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Enable DoH when Chrome is managed | Mole of Moles</title>
<meta property="fediverse:creator" content=icpmoles@mastodon.social><link rel=me href=https://mastodon.social/@icpmoles><link rel=stylesheet href=../../css/bundle.min.f4fc536ab2d3732e692b65edbe965626ecf282fec78e7620a83888ec02d8fa58.css integrity="sha256-9PxTarLTcy5pK2XtvpZWJuzygv7HjnYgqDiI7ALY+lg=" crossorigin=anonymous><link rel=stylesheet href=../../css/bundle.min.f4fc536ab2d3732e692b65edbe965626ecf282fec78e7620a83888ec02d8fa58.css integrity="sha256-9PxTarLTcy5pK2XtvpZWJuzygv7HjnYgqDiI7ALY+lg=" crossorigin=anonymous><script type=module src=../../js/relative-time-element.min.js integrity></script><script>function openLightbox(e,t){let n=document.getElementById("lb-"+t);n.showModal();let s=n.querySelector("img"),o=parseInt(s.getAttribute("width")),i=parseInt(s.getAttribute("height"));n.dataset.eventAttached!="1"&&n.addEventListener("click",e=>{let t=n.getBoundingClientRect();n.dataset.eventAttached="1",e.clientX<t.left||e.clientX>t.right||e.clientY<t.top||e.clientY>t.bottom?(n.className="",s.className="dialogimg",n.close()):o>i?n.className==""?(s.classList.add("dialogimg-ev"),n.className="dialogcontainer-ev"):(n.className="",s.className="dialogimg"):n.className==""?(s.classList.add("dialogimg-eh"),n.className="dialogcontainer-eh"):(s.className="dialogimg",n.className="")})}</script></head><body><header><h1>N<sub>A</sub> of Moles</h1><nav><ul><li><a>More</a></li><li><a href=../../>Home</a></li><li><a href=../../about/>About</a></li><li><a href=../../tags/>Tags</a></li><li><a href=https://icpmol.es/>/~icpmoles</a></li></ul></nav></header><main><article><h1>Enable DoH when Chrome is managed</h1><time datetime=2021-05-07T09:03:07+00:00>May 7, 2021</time><nav id=TableOfContents></nav><p>For whatever reason your browser is locked out from changing the <abbr title="DNS over HTTPS">DoH</abbr> settings? Here is how to change the settings if you have admin permissions.</p><p>It happened to me to buy a new laptop. This laptop comes with all the usual OEM stuff to manage security and updates. One of those software scans every downloaded file and marks its origin. To do that the software enables the <code>GroupPolicyUsers</code> and installs an extension.</p><p>Ok, cool but now whenever I want to change some Chrome (or even Firefox) settings I&rsquo;m greeted with this message:</p><p><figure><picture><source type=image/webp srcset=../../posts/chrome-doh/admin_warning_hu18251941322575434096.webp><source type=image/jpeg srcset="../../posts/chrome-doh/admin_warning_hu10575275983526627407.jpg 1x, 2x"><img class=post-img src=../../posts/chrome-doh/admin_warning_hu10575275983526627407.jpg loading=lazy width=882 height=172 onclick=openLightbox(this,0)></picture></figure><dialog id=lb-0><img class=dialogimg src=../../posts/chrome-doh/admin_warning_hu11673915722690511620.webp loading=lazy width=882 height=172></dialog></p><p>Since I wanted to use my NextDNS account I had to fix this.</p><p>First try was removing the User Policy by using a simble bash script found somewhere online</p><div class=codeblock><div class="codelang terminalIcon" contenteditable=true spellcheck=false>bash</div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>
</span></span><span class=line><span class=cl>@echo off
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>IF NOT EXIST %WINDIR%<span class=se>\\</span>System32<span class=se>\\</span>GroupPolicy goto next
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> Deleting GroupPolicy folder...
</span></span><span class=line><span class=cl>RD /S /Q <span class=s2>&#34;%WINDIR%\\System32\\GroupPolicy&#34;</span> <span class=o>||</span> goto error
</span></span><span class=line><span class=cl>echo.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>:next
</span></span><span class=line><span class=cl>IF NOT EXIST %WINDIR%<span class=se>\\</span>System32<span class=se>\\</span>GroupPolicyUsers goto next2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> Deleting GroupPolicyUsers folder...
</span></span><span class=line><span class=cl>RD /S /Q <span class=s2>&#34;%WINDIR%\\System32\\GroupPolicyUsers&#34;</span> <span class=o>||</span> goto error
</span></span><span class=line><span class=cl>echo.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>:next2
</span></span><span class=line><span class=cl>gpupdate /force
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pause
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>:error
</span></span><span class=line><span class=cl>echo.
</span></span><span class=line><span class=cl><span class=nb>echo</span> An unexpected error has occurred. Â¨Have opened the program as an administrator <span class=o>(</span>right click, run as administrator<span class=o>)</span>?
</span></span><span class=line><span class=cl>echo.
</span></span><span class=line><span class=cl>pause
</span></span><span class=line><span class=cl>exit</span></span></code></pre></td></tr></table></div></div></div><p>Look at all the delete folder commands so close to <code>System32</code>, that absolutely doesn&rsquo;t make nervous.</p><p>But this resetted at every boot. A more robust soultion was needed.</p><p>Removing the OEM security software? I was afraid of breaking some weird software integration with the fingerprint and boot security software. ðŸ˜…</p><p>Now the final solution: If you can&rsquo;t remove the User Policy use it.</p><p>Looking up about the various admin policies on the <a href="https://cloud.google.com/docs/chrome-enterprise/policies/?policy=DnsOverHttpsMode">Google Chrome</a> website it&rsquo;s possibile to find the ones useful for us: <code>DnsOverHttpsMode</code> and <code>DnsOverHttpsTemplates</code>.</p><p>Just set <code>DnsOverHttpsMode</code> to <code>secure</code> or <code>automatic</code> depending if you want it to not have an insecure fallback.</p><p>Then <code>DnsOverHttpsTemplates</code> you need to fill your DoH provider.</p><p>The <a href=https://chromeenterprise.google/policies/#DnsOverHttpsTemplates>Chrome Policy</a> is a bit confusing but you just need to take the <code>https</code> URL and add <code>/dns-query{?dns}</code> after it (<a href=https://tools.ietf.org/html/rfc8484#section-4.1.1>better explaination</a>).</p><p>So if NextDNS provides you with <code>https://dns.nextdns.io/123abc</code> your URL to fill is <code>https://dns.nextdns.io/123abc/dns-query{?dns}</code></p><p>Here is a list of various DoH providers with everything already filled in:</p><table><thead><tr><th>Provider</th><th>Standard</th><th>Family Protection</th></tr></thead><tbody><tr><td>AdGuard</td><td><code>https://dns.adguard.com/dns-query{?dns}</code></td><td><code>https://dns-family.adguard.com/dns-query{?dns}</code></td></tr><tr><td>Cloudflare</td><td><code>https://cloudflare-dns.com/dns-query{?dns}</code></td><td><code>https://family.cloudflare-dns.com/dns-query{?dns}</code></td></tr><tr><td>Google</td><td><code>https://dns.google/dns-query{?dns}</code></td><td>NA</td></tr><tr><td>OpenDNS</td><td><code>https://doh.opendns.com/dns-query{?dns}</code></td><td><code>https://doh.familyshield.opendns.com/dns-query{?dns}</code></td></tr><tr><td>Quad9<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></td><td><code>https://dns.quad9.net/dns-query{?dns}</code></td><td>NA</td></tr></tbody></table><p>Bot how to enable it? You can edit manual through <code>regedit</code> or you can copy this code in a new file and save it with a <code>.reg</code> extension. You can directly insert your DNS of choice in place of the default Google one.</p><div class=codeblock><div class="codelang codeIcon">registry</div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-registry data-lang=registry><span class=line><span class=cl>Windows Registry Editor Version 5.00
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[</span><span class=nb>HKEY_LOCAL_MACHINE</span><span class=k>\SOFTWARE\Policies\Google\Chrome]</span>
</span></span><span class=line><span class=cl><span class=na>&#34;DnsOverHttpsTemplates&#34;</span><span class=o>=</span><span class=s>&#34;https://dns.google/dns-query{?dns}&#34;</span>
</span></span><span class=line><span class=cl><span class=na>&#34;DnsOverHttpsMode&#34;</span><span class=o>=</span><span class=s>&#34;automatic&#34;</span></span></span></code></pre></td></tr></table></div></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Be aware that they provide different hostnames with different features like ECS etc. <a href="https://www.quad9.net/news/blog/doh-with-quad9-dns-servers/#:~:text=quad9%20supports%20three%20flavors%20of%20dns%20currently.">Quad9</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><hr><div><div>Tags:</div><ul><li><a href=../../tags/dns-over-https/>Dns Over Https</a></li><li><a href=../../tags/doh/>Doh</a></li><li><a href=../../tags/chrome/>Chrome</a></li></ul></div></article></main><footer><p>Copyright 2024. All rights reserved.</p><nav><ul><li><a href=../../privacy/>Privacy Policy</a></li><li><a href=../../archives/>Archive</a></li><li><a href=../../credits/>Credits</a></li><li><a href=../../posts/index.xml>RSS</a></li></ul></nav></footer></body></html>